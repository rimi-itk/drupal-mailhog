<?php

/**
 * @file
 * Contains mailhog.module.
 */

use Drupal\mailhog\Controller\MessageController;
use Drupal\mailhog\State\Settings;

/**
 * Implements hook_menu().
 */
function mailhog_menu() {
  $items['admin/config/development/mailhog'] = [
    'title' => 'MailHog',
    'description' => 'Settings for the MailHog module',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['mailhog_admin'],
    'access arguments' => ['administer site configuration'],
    'type' => MENU_NORMAL_ITEM,
  ];

  $items['admin/mailhog/messages/%/mime/part/%/download'] = [
    'page callback' => 'mailhog_message_mime_part_download',
    'page arguments' => [3, 6],
    'access arguments' => ['access content'],
  ];

  $items['admin/mailhog/messages/%/delete'] = [
    'page callback' => 'mailhog_message_delete',
    'page arguments' => [3],
    'access arguments' => ['access content'],
  ];

  $items['admin/mailhog/messages/%/release'] = [
    'page callback' => 'mailhog_message_release',
    'page arguments' => [3],
    'access arguments' => ['access content'],
  ];

  $items['admin/mailhog/messages/%'] = [
    'page callback' => 'mailhog_message_show',
    'page arguments' => [3],
    'access arguments' => ['access content'],
  ];

  $items['admin/mailhog/messages'] = [
    'title' => 'Mail messages',
    'page callback' => 'mailhog_message_list',
    'access arguments' => ['access content'],
  ];

  return $items;
}

/**
 * Mailhog admin settings form.
 */
function mailhog_admin() {
  $settings = Settings::create();
  list($defaultSenderEmail, $defaultSenderEmailSource) = $settings->getDefaultSenderEmail();

  $form['mailhog_mailhog_url'] = [
    '#title' => t('MailHog url'),
    '#type' => 'textfield',
    '#element_validate' => ['mailhog_validate_url'],
    '#required' => TRUE,
    '#default_value' => $settings->getMailHogUrl(),
    '#description' => t('MailHog url'),
  ];

  $form['mailhog_sender_email'] = [
    '#title' => t('Sender email'),
    '#type' => 'textfield',
    '#element_validate' => ['mailhog_validate_email_address'],
    '#attributes' => [
      'type' => 'email',
      'placeholder' => $defaultSenderEmail,
    ],
    '#default_value' => $settings->getSenderEmail(),
    '#description' => t('Only email sent from this address will be shown. If not set, %default_email (@default_email_source) will be used', [
      '%default_email' => $defaultSenderEmail,
      '@default_email_source' => $defaultSenderEmailSource,
    ]),
  ];

  return system_settings_form($form);
}

/**
 * Validate email address.
 */
function mailhog_validate_email_address($element, &$form_state) {
  if (!empty($element['#value']) && !valid_email_address($element['#value'])) {
    form_error($element, t('Please enter a valid email adress'));
  }
}

/**
 * Validate url.
 */
function mailhog_validate_url($element, &$form_state) {
  if (!empty($element['#value']) && !valid_url($element['#value'], TRUE)) {
    form_error($element, t('Please enter a valid url'));
  }
}

/**
 * Message list action.
 */
function mailhog_message_list() {
  return MessageController::create()->cgetAction();
}

/**
 * Message show action.
 */
function mailhog_message_show($id) {
  $id = mailhog_decode_id($id);
  return MessageController::create()->getAction($id);
}

/**
 * Message release action.
 */
function mailhog_message_release($id) {
  $id = mailhog_decode_id($id);
  return MessageController::create()->releaseAction($id);
}

/**
 * Message delete action.
 */
function mailhog_message_delete($id) {
  $id = mailhog_decode_id($id);
  return MessageController::create()->deleteAction($id);
}

/**
 * Message mime part download action.
 */
function mailhog_message_mime_part_download($id, $part) {
  $id = mailhog_decode_id($id);
  return MessageController::create()->mimePartDownloadAction($id, $part);
}

/**
 * Implements hook_library().
 */
function mailhog_library() {
  $module_path = drupal_get_path('module', 'mailhog');

  return [
    'mailhog' => [
      'title' => 'Mailhog',
      'version' => '1.0',
      'css' => [
        $module_path . '/assets/build/mailhog.css' => [],
      ],
      'js' => [
        $module_path . '/assets/build/mailhog.js' => [],
      ],
    ],
  ];
}

/**
 * Get path from mailhog route name.
 */
function mailhog_path($route, array $query = []) {
  if (isset($query['id'])) {
    $query['id'] = mailhog_encode_id($query['id']);
  }

  switch ($route) {
    case 'mailhog.message_list':
      return '/admin/mailhog/messages';

    case 'mailhog.message_show':
      return '/admin/mailhog/messages/' . $query['id'];

    case 'mailhog.message_delete':
      return '/admin/mailhog/messages/' . $query['id'] . '/delete';

    case 'mailhog.message_release':
      return '/admin/mailhog/messages/' . $query['id'] . '/release';

    case 'mailhog.message_part_download':
      return '/admin/mailhog/messages/' . $query['id'] . '/mime/part/' . $query['part'] . '/download';

  }

  throw new \Exception('Invalid route: ' . $route);
}

/**
 * Encode id.
 */
function mailhog_encode_id($id) {
  return base64_encode($id);
}

/**
 * Decode id.
 */
function mailhog_decode_id($id) {
  return base64_decode($id);
}
